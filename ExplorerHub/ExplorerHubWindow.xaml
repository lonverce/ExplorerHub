<pu:WindowX x:Class="ExplorerHub.ExplorerHubWindow"
            xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
            xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
            xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
            xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
            xmlns:pu="clr-namespace:Panuon.UI.Silver;assembly=Panuon.UI.Silver"
            mc:Ignorable="d" 
            xmlns:dd="clr-namespace:GongSolutions.Wpf.DragDrop;assembly=GongSolutions.WPF.DragDrop"
            xmlns:explorerHub="clr-namespace:ExplorerHub"
            xmlns:explorerHubs="clr-namespace:ExplorerHub.ViewModels.ExplorerHubs"
            xmlns:explorers="clr-namespace:ExplorerHub.ViewModels.Explorers"
            xmlns:ui="clr-namespace:ExplorerHub.UI"
            pu:WindowXCaption.Background="{DynamicResource {x:Static SystemColors.ActiveCaptionBrushKey}}"
            Title="文件资源管理器" 
            Height="700" Width="1000"
            d:DataContext="{d:DesignInstance explorerHubs:ExplorerHubViewModel}" 
            Padding="0">
    <pu:WindowX.Resources>
        <Style TargetType="Button"
               BasedOn="{StaticResource {x:Type Button}}">
            <Setter Property="pu:ButtonHelper.ButtonStyle" 
                    Value="Outline"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Style.Triggers>
                <DataTrigger Binding="{Binding Path=(pu:ButtonHelper.ButtonStyle),RelativeSource={RelativeSource Self}, Mode=OneWay}"
                             Value="Outline">
                    <Setter Property="pu:ButtonHelper.ClickStyle"
                            Value="Sink"/>
                    <Setter Property="Padding" Value="5,3"/>
                    <Setter Property="BorderThickness" Value="0"></Setter>
                    <Setter Property="VerticalAlignment" Value="Center"/>
                    <Setter Property="Margin" Value="3,0"></Setter>
                </DataTrigger>
            </Style.Triggers>
        </Style>
    </pu:WindowX.Resources>
    <pu:WindowXCaption.Header>
        <StackPanel Orientation="Horizontal">
            <!-- Tab标签列表 -->
            <ListBox Name="ExplorerHeaderBar" 
                   
             ItemsSource="{Binding Explorers}" 
             Height="30"
             Margin="0,5,0,0"
             BorderThickness="0"
             VerticalContentAlignment="Stretch"
             dd:DragDrop.IsDragSource="True"
             dd:DragDrop.IsDropTarget="True"
             dd:DragDrop.DropHandler="{Binding DropTarget}"
             Background="Transparent"
             SelectionMode="Single"
             SelectedIndex="{Binding SelectedIndex, Mode=TwoWay}"
             ScrollViewer.HorizontalScrollBarVisibility="Disabled">
                <ListBox.ItemContainerStyle>
                    <Style TargetType="ListBoxItem" BasedOn="{StaticResource {x:Type ListBoxItem}}">
                        <Style.Resources>
                            <explorerHubs:PositionMarginConverter x:Key="PositionMarginConverter"/>
                        </Style.Resources>
                        <Setter Property="Padding" Value="0"/>
                        <Setter Property="Margin" Value="{Binding Position, Converter={StaticResource PositionMarginConverter}, ConverterParameter=10}"/>
                        <Setter Property="VerticalAlignment" Value="Stretch"></Setter>
                        <Setter Property="ContextMenu">
                            <Setter.Value>
                                <!-->Tab标签的右键菜单</!-->
                                <ContextMenu d:DataContext="{d:DesignInstance explorers:ExplorerViewModel}">
                                    <MenuItem Header="在新窗口中打开"
                                      Command="{Binding ShowInNewWindowCommand}">
                                        <MenuItem.Icon>
                                            <TextBlock FontFamily="{StaticResource FontAwesome}">&#xf08e;</TextBlock>
                                        </MenuItem.Icon>
                                    </MenuItem>
                                </ContextMenu>
                            </Setter.Value>
                        </Setter>
                        <Setter Property="Template">
                            <Setter.Value>
                                <ControlTemplate TargetType="ListBoxItem">
                                    <ui:ChromeTabBorder BorderBrush="{TemplateBinding Background}"
                                                CornerRadius="10,10,0,0"
                                                Background="{TemplateBinding Background}">
                                        <ContentPresenter/>
                                    </ui:ChromeTabBorder>
                                    <ControlTemplate.Triggers>
                                        <Trigger Property="IsSelected" Value="True">
                                            <Setter Property="Background" Value="White"/>
                                        </Trigger>
                                        <MultiTrigger>
                                            <MultiTrigger.Conditions>
                                                <Condition Property="IsMouseOver" Value="True"/>
                                                <Condition Property="IsSelected" Value="False"></Condition>
                                            </MultiTrigger.Conditions>
                                            <Setter Property="Background" Value="{DynamicResource {x:Static SystemColors.InactiveCaptionBrushKey}}"></Setter>
                                        </MultiTrigger>
                                    </ControlTemplate.Triggers>
                                </ControlTemplate>
                            </Setter.Value>
                        </Setter>
                    </Style>
                </ListBox.ItemContainerStyle>
                <ListBox.ItemsPanel>
                    <ItemsPanelTemplate>
                        <WrapPanel Orientation="Horizontal" 
                           Background="Transparent" 
                           HorizontalAlignment="Left" VerticalAlignment="Stretch" 
                           IsItemsHost="True" />
                    </ItemsPanelTemplate>
                </ListBox.ItemsPanel>
                <ListBox.ItemTemplate>
                    <DataTemplate DataType="explorers:ExplorerViewModel">
                        <StackPanel Orientation="Horizontal" HorizontalAlignment="Left" Margin="0">
                            <StackPanel.InputBindings>
                                <!--便捷操作：按下鼠标滚轮，即可关闭标签页，无需用户准确地点击关闭按钮-->
                                <MouseBinding MouseAction="MiddleClick" 
                                      Command="{Binding ElementName=ExplorerHeaderBar, Path=DataContext.CloseBrowserCommand}"
                                      CommandParameter="{Binding}"/>
                            </StackPanel.InputBindings>
                            <StackPanel Orientation="Horizontal" 
                                HorizontalAlignment="Left">
                                <Image Source="{Binding Logo}" Width="18" Height="18" Margin="8, 2, 6, 2" VerticalAlignment="Center" />
                                <TextBlock Text="{Binding Title, Mode=OneWay, TargetNullValue=新标签}"
                                           FontSize="12" Foreground="#333333"
                                   VerticalAlignment="Center" MaxWidth="120" TextTrimming="CharacterEllipsis" Padding="5,0" />
                            </StackPanel>
                            <!-->Tab标签的关闭按钮</!-->
                            <Button FontFamily="{StaticResource FontAwesome}" 
                            Content="&#xf00d;" Background="Transparent" 
                            BorderThickness="0" 
                            Command="{Binding ElementName=ExplorerHeaderBar, Path=DataContext.CloseBrowserCommand}"
                            CommandParameter="{Binding}"
                            Foreground="LightSlateGray">
                            </Button>
                        </StackPanel>
                    </DataTemplate>
                </ListBox.ItemTemplate>
            </ListBox>
            <Button Content="&#xf067;" 
                    Command="{Binding AddBrowserCommand}"
                    Margin="0" FontFamily="{StaticResource FontAwesome}" 
                    Background="Transparent" 
                    Foreground="DimGray"/>
            </StackPanel>
        
    </pu:WindowXCaption.Header>
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>
        <DockPanel Grid.Row="0" LastChildFill="True" Margin="3,5" 
                   DataContext="{Binding ElementName=ExplorerHeaderBar, Path=SelectedItem}"
                   d:DataContext="{d:DesignInstance explorers:ExplorerViewModel}">
            <Button DockPanel.Dock="Left"
                                    FontFamily="{StaticResource FontAwesome}"
                                    Content="&#xf060;"
                                    ToolTip="后退"
                                    Command="{Binding NavigateBackwardCommand}"  />
            <Button DockPanel.Dock="Left"
                                    Content="&#xf061;"
                                    FontFamily="{StaticResource FontAwesome}"
                                    ToolTip="前进"
                                    Command="{Binding NavigateForwardCommand}" />
            <Button DockPanel.Dock="Left"
                                    Content="&#xf0aa;"
                                    FontFamily="{StaticResource FontAwesome}"
                                    ToolTip="上一层"
                                    Command="{Binding GoToParentCommand}" />
            <Button DockPanel.Dock="Right" Content="&#xf013;" FontFamily="{StaticResource FontAwesome}"
                                    ToolTip="设置" />

            <Border CornerRadius="15" Background="WhiteSmoke" Margin="5,3" Padding="10,0"
                                    VerticalAlignment="Center"
                                    Name="AddressBar">
                <DockPanel VerticalAlignment="Center">
                    <Image Source="{Binding Logo}" Width="15" Height="15" Margin="3, 2"
                                           VerticalAlignment="Center" />
                    <Button DockPanel.Dock="Right" Content="&#xf006;"
                                            FontFamily="{StaticResource FontAwesome}" ToolTip="添加收藏" />
                    <TextBox TextWrapping="NoWrap" BorderThickness="0"
                                             MaxLines="1" MaxLength="256" IsReadOnly="False" AutoWordSelection="True"
                                             Background="Transparent"
                                             FontFamily="Consola"
                                             Padding="5, 3" VerticalContentAlignment="Center"
                                             Text="{Binding NavigationPath, Mode=OneWay}"
                                             AcceptsReturn="False" 
                                             LostKeyboardFocus="SearchBox_OnLostKeyboardFocus"
                                             GotKeyboardFocus="SearchBox_OnGotKeyboardFocus"
                                             Name="SearchBox">
                        <TextBox.InputBindings>
                            <KeyBinding Key="Enter" Command="{Binding Search}"
                                                        CommandParameter="{Binding RelativeSource={RelativeSource Mode=FindAncestor, AncestorType={x:Type TextBox}}, Path=Text}" />
                        </TextBox.InputBindings>
                    </TextBox>
                </DockPanel>
            </Border>
        </DockPanel>
        
        <WindowsFormsHost  MinHeight="200" 
                           Grid.Row="1" 
                           HorizontalAlignment="Stretch" VerticalAlignment="Stretch"
                           Margin="0, 7, 0, 0" 
                           explorerHub:WindowsFormsHostHelper.ChildForm="{Binding ElementName=ExplorerHeaderBar, Path=SelectedItem.(explorers:ExplorerViewModel.Browser), Mode=OneWay}"
        />
    </Grid>
</pu:WindowX>